import json
import boto3

def lambda_handler(event, context):
    ec2 = boto3.client("ec2")

    tag_name = "Deletable"
    tag_value = "True"

    response = ec2.describe_instances(
        Filters=[
            {"Name": "tag:" + tag_name, "Values": [tag_value]},
            {"Name": "instance-state-name", "Values": ["running"]}
        ]
    )

    instances_to_stop = []
    for reservation in response["Reservations"]:
        for instance in reservation["Instances"]:
            instances_to_stop.append(instance["InstanceId"])

    if instances_to_stop:
        print(f"Stopping instances: {instances_to_stop}")
        ec2.stop_instances(InstanceIds=instances_to_stop)
    else:
        print(f"No running instances found with tag {tag_name}: {tag_value}")

    return {
        "statusCode": 200,
        "body": "EC2 shutdown process completed."
    }
